// ============================================
// MINDAUDIT SPAIN - SCHEMA DE BASE DE DATOS
// Sistema Multi-Tenant con Roles y Comisiones
// ============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// ENUMS GLOBALES
// ============================================

enum UserRole {
  ADMIN        // Administrador del sistema
  COLABORADOR  // Colaborador/Asesor que trae empresas
  EMPRESA      // Empresa que necesita auditoría
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING_VERIFICATION
}

// ============================================
// USUARIOS (Tabla principal de autenticación)
// ============================================

model User {
  id              String     @id @default(cuid())
  email           String     @unique
  name            String
  role            UserRole   @default(COLABORADOR)
  status          UserStatus @default(PENDING_VERIFICATION)
  hashedPassword  String?
  emailVerified   DateTime?
  image           String?
  
  // Relaciones polimórficas según el rol
  colaborador     Colaborador?
  empresa         Empresa?
  
  // Timestamps
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  lastLoginAt     DateTime?
  
  @@index([email])
  @@index([role])
  @@index([status])
  @@map("users")
}

// ============================================
// COLABORADORES (Asesores/Gestorías)
// ============================================

enum ColaboradorStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING_APPROVAL
}

model Colaborador {
  id                String            @id @default(cuid())
  userId            String            @unique
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Información profesional
  companyName       String            // Nombre de su gestoría/despacho
  cif               String            @unique
  phone             String
  address           String?
  city              String?
  province          String?
  postalCode        String?
  website           String?
  
  // Estado
  status            ColaboradorStatus @default(PENDING_APPROVAL)
  
  // Comisiones
  commissionRate    Decimal           @default(0) @db.Decimal(5, 2) // % configurado por admin
  totalCommissions  Decimal           @default(0) @db.Decimal(12, 2) // Total acumulado
  pendingCommissions Decimal          @default(0) @db.Decimal(12, 2) // Pendiente de pago
  
  // Documentos
  contractUrl       String?
  contractSignedAt  DateTime?
  
  // Relaciones
  empresas          Empresa[]         // Empresas que ha traído
  auditorias        Auditoria[]       // Auditorías solicitadas
  comisiones        Comision[]        // Historial de comisiones
  
  // Timestamps
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  @@index([userId])
  @@index([cif])
  @@index([status])
  @@map("colaboradores")
}

// ============================================
// EMPRESAS (Clientes que necesitan auditoría)
// ============================================

enum EmpresaStatus {
  ACTIVE
  INACTIVE
  PROSPECT      // Registrada pero sin auditoría solicitada
  IN_AUDIT      // Auditoría en proceso
  AUDITED       // Ya auditada
}

enum EmpresaOrigen {
  COLABORADOR   // Traída por un colaborador
  DIRECTA       // Registro directo en la plataforma
}

model Empresa {
  id              String         @id @default(cuid())
  userId          String?        @unique // Null si fue creada por colaborador
  user            User?          @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  // Relación con colaborador (si aplica)
  colaboradorId   String?
  colaborador     Colaborador?   @relation(fields: [colaboradorId], references: [id], onDelete: SetNull)
  
  // Origen de la empresa
  origen          EmpresaOrigen
  
  // Información de la empresa
  companyName     String
  cif             String         @unique
  contactName     String         // Persona de contacto
  contactEmail    String
  contactPhone    String?
  address         String?
  city            String?
  province        String?
  postalCode      String?
  website         String?
  
  // Información fiscal
  employees       Int?
  revenue         Decimal?       @db.Decimal(15, 2) // Facturación anual
  fiscalYear      Int?           // Año fiscal actual
  
  // Estado
  status          EmpresaStatus  @default(PROSPECT)
  notes           String?        @db.Text
  
  // Relaciones
  auditorias      Auditoria[]
  documentos      Documento[]
  
  // Timestamps
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  @@index([userId])
  @@index([colaboradorId])
  @@index([cif])
  @@index([origen])
  @@index([status])
  @@map("empresas")
}

// ============================================
// AUDITORÍAS (Servicios de auditoría)
// ============================================

enum AuditoriaStatus {
  SOLICITADA      // Recién solicitada
  EN_REVISION     // MindAudit revisando
  PRESUPUESTADA   // Presupuesto enviado
  APROBADA        // Cliente aprobó presupuesto
  EN_PROCESO      // Auditoría en ejecución
  COMPLETADA      // Auditoría finalizada
  CANCELADA       // Cancelada
  RECHAZADA       // Presupuesto rechazado
}

enum TipoServicio {
  AUDITORIA_CUENTAS           // Auditoría de cuentas anuales (obligatoria)
  AUDITORIA_CONSOLIDADA       // Auditoría de cuentas consolidadas
  AUDITORIA_VOLUNTARIA        // Auditoría voluntaria
  AUDITORIA_SUBVENCIONES      // Auditoría de subvenciones
  REVISION_LIMITADA           // Revisión limitada
  DUE_DILIGENCE              // Due diligence
  AUDITORIA_FORENSE          // Auditoría forense
  OTROS                      // Otros servicios
}

model Auditoria {
  id                String           @id @default(cuid())
  empresaId         String
  empresa           Empresa          @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  
  // Colaborador que solicitó (si aplica)
  colaboradorId     String?
  colaborador       Colaborador?     @relation(fields: [colaboradorId], references: [id], onDelete: SetNull)
  
  // Información del servicio
  tipoServicio      TipoServicio
  fiscalYear        Int              // Año fiscal a auditar
  description       String?          @db.Text
  urgente           Boolean          @default(false)
  
  // Estado
  status            AuditoriaStatus  @default(SOLICITADA)
  
  // Presupuesto
  presupuesto       Decimal?         @db.Decimal(12, 2)
  presupuestoNotas  String?          @db.Text
  presupuestoValidoHasta DateTime?
  
  // Comisión (si hay colaborador)
  comisionRate      Decimal?         @db.Decimal(5, 2) // % de comisión
  comisionAmount    Decimal?         @db.Decimal(12, 2) // Monto de comisión
  comisionPagada    Boolean          @default(false)
  
  // Fechas importantes
  fechaSolicitud    DateTime         @default(now())
  fechaPresupuesto  DateTime?
  fechaAprobacion   DateTime?
  fechaInicio       DateTime?
  fechaFinalizacion DateTime?
  
  // Relaciones
  comisiones        Comision[]
  documentos        Documento[]
  
  // Timestamps
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  
  @@index([empresaId])
  @@index([colaboradorId])
  @@index([status])
  @@index([tipoServicio])
  @@index([fechaSolicitud])
  @@map("auditorias")
}

// ============================================
// COMISIONES (Historial de pagos a colaboradores)
// ============================================

enum ComisionStatus {
  PENDIENTE       // Generada pero no pagada
  PAGADA          // Ya pagada
  CANCELADA       // Cancelada (ej: auditoría cancelada)
}

model Comision {
  id              String         @id @default(cuid())
  colaboradorId   String
  colaborador     Colaborador    @relation(fields: [colaboradorId], references: [id], onDelete: Cascade)
  auditoriaId     String
  auditoria       Auditoria      @relation(fields: [auditoriaId], references: [id], onDelete: Cascade)
  
  // Montos
  montoBase       Decimal        @db.Decimal(12, 2) // Precio de la auditoría
  porcentaje      Decimal        @db.Decimal(5, 2)  // % de comisión aplicado
  montoComision   Decimal        @db.Decimal(12, 2) // Monto a pagar
  
  // Estado
  status          ComisionStatus @default(PENDIENTE)
  
  // Pago
  fechaPago       DateTime?
  referenciaPago  String?        // Número de transferencia, etc.
  notas           String?        @db.Text
  
  // Timestamps
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  @@index([colaboradorId])
  @@index([auditoriaId])
  @@index([status])
  @@index([fechaPago])
  @@map("comisiones")
}

// ============================================
// CONFIGURACIÓN DEL SISTEMA
// ============================================

model ConfiguracionSistema {
  id                      String   @id @default(cuid())
  
  // Comisiones por defecto
  comisionDefaultRate     Decimal  @default(10) @db.Decimal(5, 2) // % por defecto
  
  // Configuración de auditorías
  diasValidezPresupuesto  Int      @default(30) // Días de validez del presupuesto
  
  // Notificaciones
  emailNotificaciones     String   @default("info@mindaudit.es")
  
  // Metadata
  metadata                Json?
  
  // Timestamps
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  
  @@map("configuracion_sistema")
}

// ============================================
// DOCUMENTOS
// ============================================

enum TipoDocumento {
  CONTRATO
  PRESUPUESTO
  INFORME_AUDITORIA
  ESTADOS_FINANCIEROS
  DOCUMENTACION_EMPRESA
  OTRO
}

model Documento {
  id              String         @id @default(cuid())
  uploadedBy      String         // User ID
  
  // Información del archivo
  fileName        String
  fileUrl         String
  fileType        String         // MIME type
  fileSize        Int            // Bytes
  
  // Clasificación
  tipoDocumento   TipoDocumento
  
  // Relaciones
  empresaId       String?
  empresa         Empresa?       @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  auditoriaId     String?
  auditoria       Auditoria?     @relation(fields: [auditoriaId], references: [id], onDelete: Cascade)
  
  // Metadata
  description     String?
  tags            String[]
  
  // Timestamps
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  @@index([uploadedBy])
  @@index([tipoDocumento])
  @@index([empresaId])
  @@index([auditoriaId])
  @@map("documentos")
}

// ============================================
// AUDIT LOG (Registro de auditoría del sistema)
// ============================================

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  APPROVE
  REJECT
  SEND
  DOWNLOAD
  PAYMENT
}

model AuditLog {
  id              String      @id @default(cuid())
  userId          String
  userRole        UserRole
  
  // Acción realizada
  action          AuditAction
  entity          String      // Nombre de la entidad
  entityId        String?     // ID de la entidad afectada
  
  // Detalles
  description     String?
  metadata        Json?
  ipAddress       String?
  userAgent       String?
  
  // Timestamp
  createdAt       DateTime    @default(now())
  
  @@index([userId])
  @@index([action])
  @@index([entity])
  @@index([createdAt])
  @@map("audit_logs")
}
