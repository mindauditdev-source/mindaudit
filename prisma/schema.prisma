generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id             String       @id @default(cuid())
  email          String       @unique
  name           String
  role           UserRole     @default(COLABORADOR)
  status         UserStatus   @default(PENDING_VERIFICATION)
  hashedPassword String?
  emailVerified  DateTime?
  image          String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  lastLoginAt    DateTime?
  colaborador    Colaborador?
  empresa        Empresa?

  // Sistema de Consultas
  horasDisponibles Float         @default(0)
  consultas        Consulta[]    @relation("ConsultasColaborador")
  comprasHoras     CompraHoras[] @relation("ComprasHoras")

  @@index([email])
  @@index([role])
  @@index([status])
  @@map("users")
}

model Colaborador {
  id                 String            @id @default(cuid())
  userId             String            @unique
  companyName        String
  cif                String            @unique
  phone              String
  address            String?
  city               String?
  province           String?
  postalCode         String?
  website            String?
  status             ColaboradorStatus @default(PENDING_APPROVAL)
  commissionRate     Decimal           @default(0) @db.Decimal(5, 2)
  totalCommissions   Decimal           @default(0) @db.Decimal(12, 2)
  pendingCommissions Decimal           @default(0) @db.Decimal(12, 2)
  contractUrl        String?
  contractSignedAt   DateTime?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  auditorias         Auditoria[]
  user               User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  comisiones         Comision[]
  empresas           Empresa[]

  @@index([userId])
  @@index([cif])
  @@index([status])
  @@map("colaboradores")
}

model Empresa {
  id            String               @id @default(cuid())
  userId        String?              @unique
  colaboradorId String?
  origen        EmpresaOrigen
  companyName   String
  cif           String               @unique
  contactName   String
  contactEmail  String
  contactPhone  String?
  address       String?
  city          String?
  province      String?
  postalCode    String?
  website       String?
  employees     Int?
  revenue       Decimal?             @db.Decimal(15, 2)
  fiscalYear    Int?
  status        EmpresaStatus        @default(PROSPECT)
  notes         String?
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
  auditorias    Auditoria[]
  documentos    Documento[]
  colaborador   Colaborador?         @relation(fields: [colaboradorId], references: [id])
  user          User?                @relation(fields: [userId], references: [id])
  solicitudes   SolicitudDocumento[]
  invoices      Invoice[]

  @@index([userId])
  @@index([colaboradorId])
  @@index([cif])
  @@index([origen])
  @@index([status])
  @@map("empresas")
}

model Auditoria {
  id                     String               @id @default(cuid())
  empresaId              String
  colaboradorId          String?
  tipoServicio           TipoServicio
  fiscalYear             Int
  description            String?
  urgente                Boolean              @default(false)
  status                 AuditoriaStatus      @default(SOLICITADA)
  presupuesto            Decimal?             @db.Decimal(12, 2)
  presupuestoNotas       String?
  presupuestoValidoHasta DateTime?
  comisionRate           Decimal?             @db.Decimal(5, 2)
  comisionAmount         Decimal?             @db.Decimal(12, 2)
  comisionPagada         Boolean              @default(false)
  fechaSolicitud         DateTime             @default(now())
  fechaPresupuesto       DateTime?
  fechaAprobacion        DateTime?
  fechaInicio            DateTime?
  fechaFinalizacion      DateTime?
  
  // Meeting Fields
  meetingRequestedBy     UserRole?
  meetingStatus          MeetingStatus        @default(PENDING)
  meetingDate            DateTime?
  meetingLink            String?

  createdAt              DateTime             @default(now())
  updatedAt              DateTime             @updatedAt
  colaborador            Colaborador?         @relation(fields: [colaboradorId], references: [id])
  empresa                Empresa              @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  comisiones             Comision[]
  documentos             Documento[]
  solicitudes            SolicitudDocumento[]
  invoice                Invoice?

  @@index([empresaId])
  @@index([colaboradorId])
  @@index([status])
  @@index([tipoServicio])
  @@index([fechaSolicitud])
  @@map("auditorias")
}

model Comision {
  id             String         @id @default(cuid())
  colaboradorId  String
  auditoriaId    String
  montoBase      Decimal        @db.Decimal(12, 2)
  porcentaje     Decimal        @db.Decimal(5, 2)
  montoComision  Decimal        @db.Decimal(12, 2)
  status         ComisionStatus @default(PENDIENTE)
  fechaPago      DateTime?
  referenciaPago String?
  notas          String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  auditoria      Auditoria      @relation(fields: [auditoriaId], references: [id], onDelete: Cascade)
  colaborador    Colaborador    @relation(fields: [colaboradorId], references: [id], onDelete: Cascade)

  @@index([colaboradorId])
  @@index([auditoriaId])
  @@index([status])
  @@index([fechaPago])
  @@map("comisiones")
}

model ConfiguracionSistema {
  id                     String   @id @default(cuid())
  comisionDefaultRate    Decimal  @default(10) @db.Decimal(5, 2)
  diasValidezPresupuesto Int      @default(30)
  emailNotificaciones    String   @default("info@mindaudit.es")
  metadata               Json?
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  @@map("configuracion_sistema")
}

model Documento {
  id            String              @id @default(cuid())
  uploadedBy    String
  fileName      String
  fileUrl       String
  fileType      String
  fileSize      Int
  tipoDocumento TipoDocumento
  empresaId     String?
  auditoriaId   String?
  description   String?
  tags          String[]
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  auditoria     Auditoria?          @relation(fields: [auditoriaId], references: [id], onDelete: Cascade)
  empresa       Empresa?            @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  solicitud     SolicitudDocumento? @relation("DocumentoSolicitud")

  @@index([uploadedBy])
  @@index([tipoDocumento])
  @@index([empresaId])
  @@index([auditoriaId])
  @@map("documentos")
}

model SolicitudDocumento {
  id          String          @id @default(cuid())
  title       String
  description String?
  status      SolicitudStatus @default(PENDIENTE)
  empresaId   String
  auditoriaId String?
  documentoId String?         @unique
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  feedback    String?
  auditoria   Auditoria?      @relation(fields: [auditoriaId], references: [id], onDelete: Cascade)
  documento   Documento?      @relation("DocumentoSolicitud", fields: [documentoId], references: [id])
  empresa     Empresa         @relation(fields: [empresaId], references: [id], onDelete: Cascade)

  @@index([empresaId])
  @@index([auditoriaId])
  @@index([status])
  @@map("solicitudes_documentos")
}

model AuditLog {
  id          String      @id @default(cuid())
  userId      String
  userRole    UserRole
  action      AuditAction
  entity      String
  entityId    String?
  description String?
  metadata    Json?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime    @default(now())

  @@index([userId])
  @@index([action])
  @@index([entity])
  @@index([createdAt])
  @@map("audit_logs")
}

enum UserRole {
  ADMIN
  COLABORADOR
  EMPRESA
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING_VERIFICATION
}

enum ColaboradorStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING_APPROVAL
}

enum EmpresaStatus {
  ACTIVE
  INACTIVE
  PROSPECT
  IN_AUDIT
  AUDITED
}

enum EmpresaOrigen {
  COLABORADOR
  DIRECTA
}

enum AuditoriaStatus {
  SOLICITADA
  EN_REVISION         // Deprecated - use SOLICITADA
  PRESUPUESTADA
  REUNION_SOLICITADA
  APROBADA            // Deprecated - use PENDIENTE_DE_PAGO
  PENDIENTE_DE_PAGO
  EN_PROCESO
  COMPLETADA
  CANCELADA
  RECHAZADA
}

enum TipoServicio {
  AUDITORIA_CUENTAS
  AUDITORIA_CONSOLIDADA
  AUDITORIA_VOLUNTARIA
  AUDITORIA_SUBVENCIONES
  REVISION_LIMITADA
  DUE_DILIGENCE
  AUDITORIA_FORENSE
  OTROS
}

enum ComisionStatus {
  PENDIENTE
  PAGADA
  CANCELADA
}

enum TipoDocumento {
  CONTRATO
  PRESUPUESTO
  INFORME_AUDITORIA
  ESTADOS_FINANCIEROS
  DOCUMENTACION_EMPRESA
  OTRO
}

enum SolicitudStatus {
  PENDIENTE
  ENTREGADO
  RECHAZADO
  APROBADO
  CANCELADA
}

enum MeetingStatus {
  PENDING
  SCHEDULED
  COMPLETED
  CANCELLED
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  APPROVE
  REJECT
  SEND
  DOWNLOAD
  PAYMENT
}

model NotificationRead {
  id             String   @id @default(cuid())
  userId         String
  notificationId String
  readAt         DateTime @default(now())

  @@unique([userId, notificationId])
  @@index([userId])
  @@map("notification_reads")
}

model Invoice {
  id          String        @id @default(cuid())
  number      String        @unique // e.g. INV-2024-001
  date        DateTime      @default(now())
  amount      Decimal       @db.Decimal(12, 2)
  tax         Decimal       @db.Decimal(12, 2)
  total       Decimal       @db.Decimal(12, 2)
  status      InvoiceStatus @default(PAID) // Usually created upon payment success
  empresaId   String
  auditoriaId String?       @unique

  empresa   Empresa    @relation(fields: [empresaId], references: [id])
  auditoria Auditoria? @relation(fields: [auditoriaId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([empresaId])
  @@map("invoices")
}

enum InvoiceStatus {
  DRAFT
  ISSUED
  PAID
  CANCELLED
}

// ============================================
// SISTEMA DE CONSULTAS
// ============================================

model Consulta {
  id                String              @id @default(cuid())
  titulo            String
  descripcion       String              @db.Text
  esUrgente         Boolean             @default(false)
  requiereVideo     Boolean             @default(false)
  archivos          ArchivoConsulta[]
  
  colaboradorId     String
  colaborador       User                @relation("ConsultasColaborador", fields: [colaboradorId], references: [id], onDelete: Cascade)
  
  categoriaId       String?
  categoria         CategoriaConsulta?  @relation(fields: [categoriaId], references: [id])
  
  horasAsignadas    Float?
  horasCustom       Float?              // Para categoría custom
  
  status            ConsultaStatus      @default(PENDIENTE)
  feedback          String?             @db.Text  // Respuesta del auditor
  
  // Meeting Fields
  meetingRequestedBy  UserRole?
  meetingStatus       MeetingStatus     @default(PENDING)
  meetingDate         DateTime?
  meetingLink         String?
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  respondidaAt      DateTime?
  aceptadaAt        DateTime?
  
  @@index([colaboradorId])
  @@index([status])
  @@index([createdAt])
  @@map("consultas")
}

model CategoriaConsulta {
  id          String      @id @default(cuid())
  nombre      String      @unique
  descripcion String?     @db.Text
  horas       Float       // Valor en horas
  isCustom    Boolean     @default(false)
  activo      Boolean     @default(true)
  orden       Int         @default(0)  // Para ordenar en UI
  consultas   Consulta[]
  
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  @@index([activo])
  @@map("categorias_consulta")
}

model ArchivoConsulta {
  id          String    @id @default(cuid())
  consultaId  String
  consulta    Consulta  @relation(fields: [consultaId], references: [id], onDelete: Cascade)
  
  nombre      String
  url         String
  size        Int
  tipo        String
  
  createdAt   DateTime  @default(now())
  
  @@index([consultaId])
  @@map("archivos_consulta")
}

model PaqueteHoras {
  id          String        @id @default(cuid())
  nombre      String
  descripcion String?       @db.Text
  horas       Int
  precio      Decimal       @db.Decimal(10, 2)  // En euros
  descuento   Int?          // Porcentaje de descuento sobre precio base
  destacado   Boolean       @default(false)  // Para marcar como "más popular"
  activo      Boolean       @default(true)
  orden       Int           @default(0)  // Para ordenar en UI
  
  compras     CompraHoras[]
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  @@index([activo])
  @@map("paquetes_horas")
}

model CompraHoras {
  id              String        @id @default(cuid())
  colaboradorId   String
  colaborador     User          @relation("ComprasHoras", fields: [colaboradorId], references: [id], onDelete: Cascade)
  
  paqueteId       String
  paquete         PaqueteHoras  @relation(fields: [paqueteId], references: [id])
  
  horas           Int           // Horas compradas
  precio          Decimal       @db.Decimal(10, 2)  // Precio pagado
  
  stripeSessionId String?       @unique
  stripePiId      String?       @unique
  
  status          PagoStatus    @default(PENDIENTE)
  
  createdAt       DateTime      @default(now())
  completedAt     DateTime?
  
  @@index([colaboradorId])
  @@index([status])
  @@index([createdAt])
  @@map("compras_horas")
}

enum ConsultaStatus {
  PENDIENTE      // Enviada por Colaborador
  COTIZADA       // Auditor respondió con horas
  ACEPTADA       // Colaborador aceptó
  RECHAZADA      // Colaborador rechazó
  EN_PROCESO     // Auditor trabajando en ella
  COMPLETADA     // Finalizada
  CANCELADA      // Cancelada por alguna razón
}

enum PagoStatus {
  PENDIENTE
  COMPLETADO
  FALLIDO
  REEMBOLSADO
}
